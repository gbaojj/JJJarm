-- Optimized Script to Reduce Memory Leak Issues
local Fluent = loadstring(game:HttpGet("https://github.com/dawid-scripts/Fluent/releases/latest/download/main.lua"))()
local SaveManager = loadstring(game:HttpGet("https://raw.githubusercontent.com/dawid-scripts/Fluent/master/Addons/SaveManager.lua"))()
local InterfaceManager = loadstring(game:HttpGet("https://raw.githubusercontent.com/dawid-scripts/Fluent/master/Addons/InterfaceManager.lua"))()

game:GetService("ReplicatedStorage").Packages.Knit.Services.WrestleService.RF.OnAutoFight:InvokeServer()

local Window = Fluent:CreateWindow({
    Title = "Arm ",
    SubTitle = "by gbao",
    TabWidth = 160,
    Size = UDim2.fromOffset(580, 460),
    Acrylic = true, 
    Theme = "Dark",
    MinimizeKey = Enum.KeyCode.LeftControl
})

local Tabs = {
    Main = Window:AddTab({ Title = "Main", Icon = "" }),
    Egg = Window:AddTab({ Title = "Egg", Icon = "" }),
    Settings = Window:AddTab({ Title = "Settings", Icon = "settings" })
    
}

local Options = Fluent.Options
local VirtualInputManager = game:GetService("VirtualInputManager")
local npcPath = workspace.GameObjects.RngNPCs.BlossomVillage.Npc

local isAutoFarming = false
local activeThreads = {}

-- Helper to manage threads
local function stopThread(threadName)
    if activeThreads[threadName] then
        activeThreads[threadName] = false
    end
end

local function startThread(threadName, func)
    stopThread(threadName) -- Stop any existing thread with the same name
    activeThreads[threadName] = true
    task.defer(function()
        while activeThreads[threadName] do
            func()
        end
    end)
end

-- Function to update proximity prompts
local function updateProximityPrompts(folder)
    for _, descendant in ipairs(folder:GetDescendants()) do
        if descendant:IsA("ProximityPrompt") then
            descendant.HoldDuration = 0 -- ƒê·∫∑t th·ªùi gian gi·ªØ ph√≠m E = 0
            descendant.Style = Enum.ProximityPromptStyle.Default
            descendant.MaxActivationDistance = 6 -- TƒÉng kho·∫£ng c√°ch k√≠ch ho·∫°t
        end
    end
end


-- Function for Auto NPC Farming
local function interactWithNPC()
    task.wait(0.1) -- ƒê·ª£i m·ªôt ch√∫t tr∆∞·ªõc khi g·ª≠i ph√≠m
    VirtualInputManager:SendKeyEvent(true, Enum.KeyCode.E, false, game)
    task.wait(0.1)
    VirtualInputManager:SendKeyEvent(false, Enum.KeyCode.E, false, game)
end

local AutoBeatNPCToggle = Tabs.Main:AddToggle("AutoBeatNPC", {
    Title = "Auto Beat NPC",
    Default = false
})

AutoBeatNPCToggle:OnChanged(function()
    isAutoFarming = AutoBeatNPCToggle.Value

    if isAutoFarming then
        -- C·∫≠p nh·∫≠t ProximityPrompt cho t·∫•t c·∫£ c√°c NPC hi·ªán t·∫°i trong npcPath
        for _, npc in ipairs(npcPath:GetChildren()) do
            if npc:IsA("Model") and npc:FindFirstChild("Table") and npc.Table:FindFirstChild("PlayerRoot") then
                updateProximityPrompts(npc) -- C·∫≠p nh·∫≠t ProximityPrompt cho NPC
            end
        end

        -- L·∫Øng nghe s·ª± ki·ªán ChildAdded ƒë·ªÉ c·∫≠p nh·∫≠t c√°c NPC m·ªõi
        npcPath.ChildAdded:Connect(function(child)
            if child:IsA("Model") and child:FindFirstChild("Table") and child.Table:FindFirstChild("PlayerRoot") then
                updateProximityPrompts(child) -- C·∫≠p nh·∫≠t ProximityPrompt cho NPC m·ªõi
            end
        end)

        -- Ti·∫øn h√†nh t∆∞∆°ng t√°c v·ªõi NPC
        startThread("NPCFarm", function()
            while isAutoFarming do
                for _, npc in ipairs(npcPath:GetChildren()) do
                    if not isAutoFarming then break end
                    if npc:IsA("Model") and npc:FindFirstChild("Table") and npc.Table:FindFirstChild("PlayerRoot") then
                        local humanoid = game.Players.LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
                        if humanoid then   
                            humanoid.CFrame = npc.Table.PlayerRoot.CFrame
                            task.wait(0.5) -- Short delay to avoid overlapping actions
                            interactWithNPC()
                            task.wait(3.5)
                        end
                    end
                end
                task.wait(1)
            end
        end)
    else
        stopThread("NPCFarm")
    end
end)

-- Function for Auto Buying
local AutoBuyToggle = Tabs.Main:AddToggle("AutoBuyToggle", {
    Title = "Auto Buy (Selected Slots)",
    Default = false
})

local BlackMarketDropdown = Tabs.Main:AddDropdown("BlackMarketDropdown", {
    Title = "Select Merchant Slot(s)",
    Values = {1, 2, 3, 4, 5},
    Multi = true,
    Default = {}
})

AutoBuyToggle:OnChanged(function()
    if AutoBuyToggle.Value then
        startThread("AutoBuy", function()
            for i = 1, 3 do
                for number, isSelected in pairs(BlackMarketDropdown.Value) do
                    if not AutoBuyToggle.Value then break end
                    if isSelected then
                        local args = {
                            [1] = "Blossom Merchant",
                            [2] = number
                        }
                        game:GetService("ReplicatedStorage").Packages.Knit.Services.LimitedMerchantService.RF.BuyItem:InvokeServer(unpack(args))
                        task.wait(10)
                    end
                end
            end
            task.wait(90) -- Wait 90 seconds before next cycle
        end)
    else
        stopThread("AutoBuy")
    end
end)

-- Function for Auto Spin
local AutoSpinToggle = Tabs.Main:AddToggle("AutoSpin", {
    Title = "Auto Spin",
    Default = false
})

AutoSpinToggle:OnChanged(function()
    if AutoSpinToggle.Value then
        startThread("AutoSpin", function()
            local args = {
                [1] = "Ninja Fortune",
                [2] = "x25"
            }
            game:GetService("ReplicatedStorage").Packages.Knit.Services.SpinnerService.RF.Spin:InvokeServer(unpack(args))
            task.wait(3)
        end)
    else
        stopThread("AutoSpin")
    end
end)

-- Function for Auto Claim Daily Reward
local AutoClaimRewardToggle = Tabs.Main:AddToggle("AutoClaimReward", {
    Title = "Auto Claim Daily Reward",
    Default = false
})

AutoClaimRewardToggle:OnChanged(function()
    if AutoClaimRewardToggle.Value then
        startThread("AutoClaimReward", function()
            game:GetService("ReplicatedStorage").Packages.Knit.Services.DailyRewardService.RE.onClaimReward:FireServer()
            task.wait(1800) -- Wait 30 minutes before claiming again
        end)
    else
        stopThread("AutoClaimReward")
    end
end)

-- Th√™m Dropdown ƒë·ªÉ ch·ªçn lo·∫°i Boost
local BoostDropdown = Tabs.Egg:AddDropdown("BoostDropdown", {
    Title = "Ch·ªçn Lo·∫°i Boost",
    Values = {"Luck", "Training", "Candy"}, -- Danh s√°ch c√°c Boost c√≥ th·ªÉ mua
    Multi = false, -- Ch·ªâ ƒë∆∞·ª£c ch·ªçn m·ªôt lo·∫°i Boost
    Default = "Luck" -- Gi√° tr·ªã m·∫∑c ƒë·ªãnh
})

-- Th√™m n√∫t chuy·ªÉn ƒë·ªïi (toggle) Auto Buy Boost
local AutoBuyBoost = Tabs.Egg:AddToggle("AutoBuyBoost", {
    Title = "Auto Mua Boost",
    Default = false
})

AutoBuyBoost:OnChanged(function()
    if AutoBuyBoost.Value then
        startThread("AutoBuyBoost", function()
            while AutoBuyBoost.Value do
                -- L·∫•y lo·∫°i Boost ƒë∆∞·ª£c ch·ªçn t·ª´ Dropdown
                local selectedBoost = BoostDropdown.Value or "Luck" -- M·∫∑c ƒë·ªãnh l√† "Luck" n·∫øu kh√¥ng c√≥ gi√° tr·ªã

                local args = {
                    [1] = selectedBoost -- Lo·∫°i Boost ƒë∆∞·ª£c ch·ªçn
                }

                -- G·ª≠i y√™u c·∫ßu ƒë·∫øn m√°y ch·ªß ƒë·ªÉ mua Boost
                game:GetService("ReplicatedStorage").Packages.Knit.Services.ChiUpgradeService.RF.BuyBoost:InvokeServer(unpack(args))
                task.wait(30) -- Ch·ªù 5 gi√¢y tr∆∞·ªõc khi mua l·∫°i
            end
        end)
    else
        stopThread("AutoBuyBoost") -- D·ª´ng lu·ªìng AutoBuyBoost
    end
end)



-- Th√™m Dropdown ƒë·ªÉ ch·ªçn t√™n tr·ª©ng
local EggDropdown = Tabs.Egg:AddDropdown("EggDropdown", {
    Title = "Ch·ªçn T√™n Tr·ª©ng",
    Values = {"Ultimate", "Mutant", "Samurai"}, -- Danh s√°ch c√°c tr·ª©ng c√≥ th·ªÉ m·ªü
    Multi = false, -- Ch·ªâ ƒë∆∞·ª£c ch·ªçn m·ªôt lo·∫°i tr·ª©ng
    Default = "Ultimate" -- Gi√° tr·ªã m·∫∑c ƒë·ªãnh
})

-- Th√™m n√∫t chuy·ªÉn ƒë·ªïi (toggle) Auto Egg
local AutoEgg = Tabs.Egg:AddToggle("AutoEGG", {
    Title = "Auto M·ªü Tr·ª©ng",
    Default = false
})

AutoEgg:OnChanged(function()
    if AutoEgg.Value then
        startThread("AutoEGG", function()
            while AutoEgg.Value do
                -- L·∫•y gi√° tr·ªã tr·ª©ng ƒë∆∞·ª£c ch·ªçn t·ª´ Dropdown
                local selectedEgg = EggDropdown.Value or "Ultimate" -- M·∫∑c ƒë·ªãnh l√† "Lava" n·∫øu kh√¥ng c√≥ gi√° tr·ªã

                local args = {
                    [1] = selectedEgg, -- T√™n tr·ª©ng ƒë∆∞·ª£c ch·ªçn
                    [2] = nil, -- Placeholder for unknown argument
                    [3] = nil, -- Triple Egg (Gamepass)
                    [4] = false, -- Auto Egg (Gamepass)
                    [5] = nil, -- Placeholder for unknown argument
                    [6] = true -- Max Egg
                }

                -- G·ª≠i y√™u c·∫ßu ƒë·∫øn m√°y ch·ªß ƒë·ªÉ m·ªü tr·ª©ng
                game:GetService("ReplicatedStorage").Packages.Knit.Services.EggService.RF.purchaseEgg:InvokeServer(unpack(args))
                task.wait(1) -- Ch·ªù 3 gi√¢y tr∆∞·ªõc khi l·∫∑p l·∫°i
            end
        end)
    else
        stopThread("AutoEGG") -- D·ª´ng lu·ªìng AutoEGG
    end
end)

-- Th√™m Toggle cho Auto Dragon Trial
local AutoDragonTrialToggle = Tabs.Main:AddToggle("AutoDragonTrial", {
    Title = "Auto Dragon Trial",
    Default = false
})

-- H√†m ki·ªÉm tra v√† tham gia Dragon Trial
autoDragonTrialActive = false

AutoDragonTrialToggle:OnChanged(function()
    autoDragonTrialActive = AutoDragonTrialToggle.Value

    if autoDragonTrialActive then
        startThread("AutoDragonTrial", function()
            while autoDragonTrialActive do
                local TextLabel = game:GetService("Players").LocalPlayer.PlayerGui.Misc.Trials.Timer.Dragon.Timer
                if TextLabel then
                    print("Countdown Text:", TextLabel.Text) -- Debug console
                    
                    if TextLabel.Text == "Ready!" then
                        -- üî¥ D·ª´ng Auto NPC HO√ÄN TO√ÄN tr∆∞·ªõc khi tham gia Trial
                        if isAutoFarming then
                            stopThread("NPCFarm")  -- D·ª´ng Auto NPC
                            isAutoFarming = false  -- ƒê·∫∑t tr·∫°ng th√°i Auto NPC th√†nh false
                            task.wait(1)  -- ƒê·ª£i 1 gi√¢y ƒë·ªÉ ƒë·∫£m b·∫£o NPCFarm ƒë√£ d·ª´ng
                        end

                        -- üîµ Ch·ªù 5 gi√¢y tr∆∞·ªõc khi g·ª≠i request v√†o Dragon Trial
                        task.wait(5)

                        -- üü¢ Tham gia Dragon Trial
                        game:GetService("ReplicatedStorage").Packages.Knit.Services.WrestleService.RF.OnClick:InvokeServer()
                        game:GetService("ReplicatedStorage").Packages.Knit.Services.ChampionshipService.RF.RequestJoin:InvokeServer("Dragon")
                        
                        -- L·∫•y th·ªùi gian countdown t·ª´ GUI
                        local minutes, seconds = TextLabel.Text:match("(%d+)%s?m%s?(%d+)%s?s")
                        local countdown = (tonumber(minutes) or 5) * 60 + (tonumber(seconds) or 0)
                        local startTime = os.time()
                        
                        while autoDragonTrialActive do
                            task.wait(1)
                            local elapsedTime = os.time() - startTime
                            print("Time remaining:", countdown - elapsedTime, "seconds") -- Debug console
                            if elapsedTime >= countdown then
                                break
                            end
                        end
                        
                        -- üîÑ Ti·∫øp t·ª•c Auto NPC ch·ªâ khi Auto Dragon Trial v·∫´n b·∫≠t
                        if AutoDragonTrialToggle.Value then
                            isAutoFarming = true
                            startThread("NPCFarm", function()
                                while isAutoFarming do
                                    for _, npc in ipairs(npcPath:GetChildren()) do
                                        if not isAutoFarming then break end
                                        if npc:IsA("Model") and npc:FindFirstChild("Table") and npc.Table:FindFirstChild("PlayerRoot") then
                                            local humanoid = game.Players.LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
                                            if humanoid then   
                                                humanoid.CFrame = npc.Table.PlayerRoot.CFrame
                                                task.wait(0.5)
                                                interactWithNPC()
                                                task.wait(3.5)
                                            end
                                        end
                                    end
                                    task.wait(1)
                                end
                            end)
                        end
                    end
                end
                task.wait(1)
            end
        end)
    else
        stopThread("AutoDragonTrial")
    end
end)

-- Th√™m Toggle cho Auto Training Barbell
local AutoTrainingToggle = Tabs.Main:AddToggle("AutoTraining", {
    Title = "Auto Training Barbell",
    Default = false
})

AutoTrainingToggle:OnChanged(function()
    if AutoTrainingToggle.Value then
        startThread("AutoTraining", function()
            while AutoTrainingToggle.Value do
                -- Ch·ªçn Auto Training Biceps
                local args1 = {
                    [1] = "AutoTraining",
                    [2] = {
                        ["TrainingType"] = "Biceps"
                    }
                }
                game:GetService("ReplicatedStorage").Packages.Knit.Services.AutoService.RF.SetRejoin:InvokeServer(unpack(args1))
                task.wait(2)
                
                -- Ch·ªçn Barbell
                local args2 = {
                    [1] = "DragonTemple",
                    [2] = "Barbells",
                    [3] = "DragonTemple3"
                }
                game:GetService("ReplicatedStorage").Packages.Knit.Services.ToolService.RE.onEquipRequest:FireServer(unpack(args2))
                task.wait(2) -- ƒêi·ªÅu ch·ªânh th·ªùi gian ch·ªù gi·ªØa c√°c l·∫ßn g·ª≠i y√™u c·∫ßu

                -- K√≠ch ho·∫°t auto-training sau khi trang b·ªã barbell
               
                game:GetService("ReplicatedStorage"):WaitForChild("Packages"):WaitForChild("Knit"):WaitForChild("Services"):WaitForChild("ToolService"):WaitForChild("RE"):WaitForChild("onClick"):FireServer()
                
                
                -- Th√™m th·ªùi gian ch·ªù ƒë·ªÉ tr√°nh g·ª≠i y√™u c·∫ßu qu√° nhanh
                task.wait(0.5)
            end
        end)
    else
        stopThread("AutoTraining")
    end
end)



-- SaveManager and InterfaceManager Setup
SaveManager:SetLibrary(Fluent)
InterfaceManager:SetLibrary(Fluent)
SaveManager:IgnoreThemeSettings()
SaveManager:SetIgnoreIndexes({})
InterfaceManager:SetFolder("FluentScriptHub")
SaveManager:SetFolder("FluentScriptHub/specific-game")

InterfaceManager:BuildInterfaceSection(Tabs.Settings)
SaveManager:BuildConfigSection(Tabs.Settings)
Window:SelectTab(1)

Fluent:Notify({
    Title = "Fluent",
    Content = "The script has been loaded.",
    Duration = 8
})

-- Load Auto-Config
SaveManager:LoadAutoloadConfig()
